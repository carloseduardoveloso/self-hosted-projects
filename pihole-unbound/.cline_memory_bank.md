# Cline Memory Bank - Pi-hole + Unbound Project

## Project Overview
This is a Docker Compose setup for Pi-hole (DNS ad-blocker) combined with Unbound (recursive DNS resolver) for enhanced privacy and performance. The project includes automatic updates via Watchtower and comprehensive health monitoring.

## Key Technical Details

### Architecture
- **Pi-hole**: Container running on 172.20.0.5, handles DNS filtering and ad-blocking
- **Unbound**: Container running on 172.20.0.6, provides recursive DNS resolution
- **Watchtower**: Automatic container updates with label-based filtering
- **Custom Network**: 172.20.0.0/16 subnet for isolated communication

### Port Configuration
- **Pi-hole**: 53 (DNS), 80 (HTTP), 443 (HTTPS), 123 (NTP)
- **Unbound**: 5053 (external access), 53 (internal container port)
- **Network Communication**: Pi-hole → Unbound via 172.20.0.6#5053

### Security Features
- Unbound runs with read-only filesystem
- No new privileges security option enabled
- DNSSEC validation enabled
- Privacy mode configured
- Health checks for all services

### Performance Optimizations
- Configurable Unbound threads and cache size
- Pi-hole cache size set to 10,000 entries
- Optimized DNS query logging
- Tmpfs for temporary files in Unbound

## Environment Variables
```bash
TZ=America/Sao_Paulo                    # Timezone
PIHOLE_PASSWORD=your_secure_password    # Pi-hole web interface password
PIHOLE_HOSTNAME=pihole.local           # Hostname for Pi-hole
UNBOUND_THREADS=2                      # Unbound performance tuning
UNBOUND_CACHE_SIZE=256m                # Unbound cache size
UNBOUND_VERBOSITY=1                    # Unbound logging level
```

## Volume Mappings
- `./etc-pihole` → Pi-hole configuration and databases
- `./etc-dnsmasq.d` → Custom dnsmasq configuration
- `./var-log` → Pi-hole logs
- `./unbound-config` → Custom Unbound configuration
- `./unbound-logs` → Unbound logs

## Health Check Commands
- **Pi-hole**: `dig @127.0.0.1 -p 53 google.com`
- **Unbound**: `dig @127.0.0.1 -p 53 cloudflare.com +short`

## Important Configuration Notes
- Pi-hole configured to use Unbound as upstream DNS: `172.20.0.6#5053`
- DNSSEC validation enabled for security
- Query logging enabled for monitoring
- Privacy mode set to level 3 (maximum privacy)
- Watchtower configured for daily updates with label-based filtering

## Common Commands
```bash
# Start services
docker-compose up -d

# View logs
docker-compose logs -f

# Check service health
docker-compose ps

# Update containers
docker-compose pull && docker-compose up -d

# Test DNS resolution
dig @server-ip google.com
dig @server-ip -p 5053 google.com  # Direct Unbound test
```

## Troubleshooting Tips
1. **Port conflicts**: Check if ports 53, 80, 443 are available
2. **DNS issues**: Verify health checks and container logs
3. **Performance**: Monitor resource usage and adjust cache sizes
4. **Network**: Ensure custom network is properly configured
5. **Updates**: Watchtower logs show update activities

## File Structure
```
pihole-unbound/
├── docker-compose.yml      # Main configuration
├── .env                   # Environment variables
├── README.md              # Documentation
├── .cline_memory_bank.md  # This file
├── etc-pihole/           # Pi-hole data (auto-created)
├── etc-dnsmasq.d/        # Custom dnsmasq config
├── var-log/              # Pi-hole logs
├── unbound-config/       # Unbound configuration
└── unbound-logs/         # Unbound logs
```

## Recent Changes Made
1. **Enhanced docker-compose.yml**:
   - Added custom network with static IPs
   - Implemented comprehensive health checks
   - Added Watchtower for automatic updates
   - Enhanced security with read-only containers
   - Added performance tuning options
   - Configured proper service dependencies

2. **Created comprehensive README.md**:
   - Complete installation and configuration guide
   - Troubleshooting section
   - Security and performance documentation
   - Advanced configuration examples

3. **Key Improvements**:
   - Static IP addressing for reliable communication
   - Health check dependencies (Pi-hole waits for Unbound)
   - Security hardening (read-only, no-new-privileges)
   - Performance optimization variables
   - Automatic update management
   - Comprehensive logging setup

## Best Practices Implemented
- All comments and descriptions in English
- Consistent naming conventions
- Health checks for all services
- Security-first configuration
- Performance optimization
- Comprehensive documentation
- Environment variable usage for flexibility
- Proper service dependencies
- Volume persistence for data
- Network isolation for security

## Future Considerations
- Consider adding Prometheus monitoring
- Implement backup strategies for Pi-hole data
- Add custom Unbound configuration examples
- Consider adding DoH (DNS over HTTPS) support
- Implement log rotation for long-term deployments
